# CAP-分布式系统的三个指标

CAP 是以下三个单词的首字母拼成, 

```
Consistency (一致性)
Availability (可用性)
Partition tolerance (分区容错性)
```

由加州大学 Eric Brewer 提出, 并且给出 CAP 三个指标不可能同时做到的猜想. 也称为 CAP 定理

## Consistency 一致性

一致性指 在所有节点访问能访问到同一份最新的数据副本, 这个很好理解, 例如在 数据库分库后, 我们需要保证读库和写库的数据一致性.

在并发读写时非常容易出现一致性问题, 所以在考虑一致性问题是, 要注意结合并发读写的场景.

**通常有三种一致性策略**

* 对于关系型数据库, 要求更新过的数据能被后续的访问都看到, 这是 `强一致性`
* 如果能容忍后续的 `一部分` 或者 `全部` 访问不到, 则是 `弱一致性`
* 如果经过一段时间后 要求能访问到更新后的数据, 则是 `最终一致性`

CAP 中的 一致性 指的是 `强一致性`

## Availability 可用性

可用性也就是说 这个节点 或者 服务 是一直可以正常响应请求的. 这和 `利用多副本实现无状态节点的高可用` 中的 `可用` 是相同的意思.

通常通过 `停机时间` 来衡量一个系统的可用性.

可用性分类|可用水平|年可容忍停机时间
-|-|-
容错可用性 | 99.9999 | <1 min
极高可用性 | 99.999  |<5 min
具有故障自动恢复能力的可用性 | 99.99 | <53 min
高可用性 | 99.9 | <8.8 h
商品可用性 | 99 | <43.8 h

计算停机时间的公式如下 `(1- 可用水平百分数)*365*24*60` 得到 全年可容忍的停机时间 分钟数

## Partition Tolerance (分区容忍度)

对于 `Partition Tolerance` , 通常有些文献中被翻译成 `分区容错性` , 个人觉得这样容易产生歧义, 更贴切的翻译个人认为是 `分区容忍性`

以下来自 _邬江-CAP理论中的P到底是个什么意思? 的回答- 知乎_
> 一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障，使得有些节点之间不连通了，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中。这就叫分区。
> 
> 当你一个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。
> 
> 提高分区容忍性的办法就是一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里。容忍性就提高了。
> 
> 然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。
>
> 总的来说就是，数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。

## 为何 C/A/P 三者中会出现 "三选二" 的情况




ref:
> 
> 1. [hollis-分布式系统的CAP理论(通俗易懂, 推荐)](https://www.hollischuang.com/archives/666)
> 1. [邬江-CAP理论中的P到底是个什么意思? 的回答- 知乎](https://www.zhihu.com/question/54105974/answer/139037688)
> 1. [wiki-CAP](https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86)